<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Cart | Amexan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="images/favicon.png" />
<link rel="shortcut icon" href="images/favicon.png" type="image/png" />
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    :root {
      --brand-blue: #0000CD;
      --brand-blue-hover: #0000B8;
      --brand-blue-light: #F0F0FF;
      --brand-blue-lighter: #F8F8FF;
    }
    
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      min-height: 100vh;
    }
    
    .btn-primary { 
      background-color: var(--brand-blue);
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: var(--brand-blue-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0, 0, 205, 0.25);
    }
    .btn-success {
      background-color: #059669;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .btn-success:hover {
      background-color: #047857;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.25);
    }
    
    .cart-item {
      transition: all 0.2s ease;
    }
    .cart-item:hover {
      background-color: var(--brand-blue-lighter);
    }
    
    .qty-btn {
      transition: all 0.2s ease;
      font-weight: 600;
    }
    .qty-btn:hover {
      background-color: var(--brand-blue) !important;
      color: white !important;
      transform: scale(1.1);
    }
    
    .remove-btn {
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .remove-btn:hover {
      background-color: #fee2e2 !important;
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }
    
    .product-image {
      transition: all 0.3s ease;
      border: 2px solid var(--brand-blue-light);
    }
    .product-image:hover {
      transform: scale(1.05);
      border-color: var(--brand-blue);
      box-shadow: 0 4px 12px rgba(0, 0, 205, 0.2);
    }
    
    .cart-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    
    .cart-card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .mobile-cart-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    
    .mobile-cart-card:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }
    
    .summary-card {
      background: linear-gradient(135deg, var(--brand-blue-lighter) 0%, var(--brand-blue-light) 100%);
      border: 1px solid var(--brand-blue-light);
    }
    
    #cartCount {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      font-size: 11px;
    }
    
    /* Image loading states */
    .image-loading {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .image-loaded {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Compact mobile design */
    @media (max-width: 768px) {
      .mobile-hide { display: none !important; }
      .desktop-hide { display: block !important; }
      
      .mobile-cart-card {
        margin-bottom: 12px;
        padding: 12px;
      }
      
      .mobile-product-image {
        width: 60px;
        height: 60px;
      }
      
      .mobile-title {
        font-size: 16px;
        line-height: 1.3;
      }
    }
    
    @media (min-width: 769px) {
      .desktop-hide { display: none !important; }
    }
  </style>
</head>
<body>

  <!-- âœ… Amexan Navbar -->
  <header class="shadow-lg sticky top-0 z-50" style="background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-hover) 100%);">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="index.html" class="text-xl md:text-2xl font-bold text-white flex items-center">
        <span class="bg-white text-blue-700 px-2 py-1 rounded mr-2 text-sm md:text-base">A</span>mexan
      </a>
      <nav class="space-x-4 md:space-x-6 hidden md:flex">
        <a href="index.html" class="text-blue-100 hover:text-white font-medium transition-colors text-sm md:text-base">Home</a>
        <a href="products.html" class="text-blue-100 hover:text-white font-medium transition-colors text-sm md:text-base">Shop</a>
        <a href="cart.html" class="text-white font-bold border-b-2 border-white text-sm md:text-base">Cart</a>
      </nav>
      <div class="relative">
        <a href="cart.html" class="text-blue-100 hover:text-white transition-colors">
          <span class="text-xl md:text-2xl">ðŸ›’</span>
          <span id="cartCount" class="text-xs font-bold text-white bg-red-500 px-1 py-0.5 rounded-full absolute -top-1 -right-2">0</span>
        </a>
      </div>
    </div>
  </header>

  <!-- âœ… Cart Page Title -->
  <div class="text-center mt-6 md:mt-10 mb-6 md:mb-8 px-4">
    <h1 class="text-2xl md:text-4xl font-bold flex items-center justify-center" style="color: var(--brand-blue);">
      <span class="mr-2 md:mr-3">ðŸ›’</span> Your Shopping Cart
    </h1>
    <p class="text-gray-600 mt-2 text-sm md:text-base">Review and manage your items</p>
  </div>

  <!-- âœ… Empty Cart Message -->
  <div id="emptyCartMessage" class="text-center mt-12 md:mt-16 py-8 md:py-12 px-4 hidden">
    <div class="max-w-lg mx-auto">
      <div class="w-16 md:w-24 h-16 md:h-24 mx-auto rounded-full flex items-center justify-center mb-4 md:mb-6" style="background-color: var(--brand-blue-light);">
        <span class="text-2xl md:text-4xl" style="color: var(--brand-blue);">ðŸ›’</span>
      </div>
      <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-3 md:mb-4">Your cart is empty</h3>
      <p class="text-gray-600 mb-6 md:mb-8 max-w-md mx-auto text-sm md:text-base">
        Looks like you haven't added anything to your cart yet. Start shopping to find amazing products!
      </p>
      <a href="dashboard.html" class="btn-primary inline-block px-6 md:px-8 py-2.5 md:py-3 text-white rounded-lg font-medium text-sm md:text-lg">
        Continue Shopping
      </a>
    </div>
  </div>

  <!-- âœ… Cart Section -->
  <div id="cartSection" class="hidden max-w-7xl mx-auto px-4 mt-6 md:mt-8">
    
    <!-- Desktop Table View -->
    <div class="cart-card mobile-hide overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="text-white text-sm" style="background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-hover) 100%);">
            <tr>
              <th class="px-3 md:px-4 py-3 font-semibold text-left">#</th>
              <th class="px-3 md:px-6 py-3 font-semibold text-left">Product</th>
              <th class="px-3 md:px-4 py-3 font-semibold text-left">Color</th>
              <th class="px-3 md:px-4 py-3 font-semibold text-left">Price</th>
              <th class="px-3 md:px-4 py-3 font-semibold text-center">Qty</th>
              <th class="px-3 md:px-4 py-3 font-semibold text-left">Total</th>
              <th class="px-3 md:px-4 py-3 font-semibold text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="cartTableBody" class="divide-y divide-gray-100">
            <!-- Dynamic rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Card View -->
    <div id="mobileCartItems" class="desktop-hide space-y-3">
      <!-- Dynamic mobile cards -->
    </div>

    <!-- âœ… Cart Summary -->
    <div class="mt-6 md:mt-8">
      <div class="cart-card overflow-hidden">
        <div class="flex flex-col xl:flex-row gap-6 p-4 md:p-6">
          
          <!-- Coupon Section -->
          <div class="flex-1">
            <h3 class="text-lg font-semibold mb-3" style="color: var(--brand-blue);">Coupon Code</h3>
            <div class="flex items-center max-w-md">
              <input 
                type="text" 
                placeholder="Enter coupon code" 
                class="flex-1 border border-gray-300 rounded-l-lg px-3 md:px-4 py-2 md:py-2.5 text-sm focus:outline-none focus:ring-2 focus:border-transparent"
                style="focus:ring-color: var(--brand-blue);"
              >
              <button class="bg-gray-800 text-white px-4 md:px-6 py-2 md:py-2.5 rounded-r-lg font-medium hover:bg-gray-700 transition-colors text-sm">
                Apply
              </button>
            </div>
          </div>
          
          <!-- Summary Section -->
          <div class="w-full xl:w-80">
            <div class="summary-card rounded-xl p-4 md:p-5">
              <h3 class="text-lg font-bold mb-4" style="color: var(--brand-blue);">Order Summary</h3>
              
              <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Subtotal:</span>
                  <span id="subtotal" class="font-medium text-gray-800">KES 0</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Tax (0%):</span>
                  <span id="tax" class="font-medium text-gray-800">KES 0</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Shipping:</span>
                  <span class="font-medium text-green-600">Free</span>
                </div>
              </div>
              
              <div class="border-t border-gray-200 pt-3 mb-5">
                <div class="flex justify-between">
                  <span class="text-lg font-bold" style="color: var(--brand-blue);">Total:</span>
                  <span id="total" class="text-xl font-bold text-green-600">KES 0</span>
                </div>
              </div>
              
              <div class="space-y-3">
                <a href="dashboard.html" class="btn-primary block text-center px-4 py-2.5 rounded-lg font-medium text-white text-sm">
                  Continue Shopping
                </a>
                <a href="checkout.html" class="btn-success block text-center px-4 py-2.5 rounded-lg font-medium text-white text-sm">
                  Proceed to Checkout
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Footer -->
  <footer class="mt-12 md:mt-20 border-t bg-white">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-6 md:mb-0 text-center md:text-left">
          <a href="index.html" class="text-xl md:text-2xl font-bold" style="color: var(--brand-blue);">Amexan</a>
          <p class="mt-2 text-gray-600 max-w-md text-sm">Premium medical equipment and supplies for professionals worldwide.</p>
        </div>
      </div>
      
      <div class="border-t border-gray-200 mt-6 pt-6 text-center text-xs md:text-sm text-gray-500">
        <p>Â© 2025 Amexan Medical Intelligence. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCet4LIMVEHc8w1hrHhrFvg-Zw-9H7TN-k",
      authDomain: "bynexproject.firebaseapp.com",
      projectId: "bynexproject",
      storageBucket: "bynexproject.appspot.com",
      messagingSenderId: "667246369908",
      appId: "1:667246369908:web:1cbbbe51da7673246c8521",
      measurementId: "G-7CCRBG0P8D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global cart functions
    const CART_KEY = "amexan_cart";
    
    function getCart() {
      return JSON.parse(localStorage.getItem(CART_KEY)) || [];
    }
    
    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateCartCount();
    }
    
    function updateCartCount() {
      const cart = getCart();
      const count = cart.reduce((total, item) => total + item.qty, 0);
      const countElement = document.getElementById('cartCount');
      
      if (countElement) {
        countElement.textContent = count;
        countElement.style.display = count > 0 ? 'flex' : 'none';
      }
    }

    // Enhanced Firebase image loading - exact same as product detail page
    async function loadProductImage(productId, fallbackUrl) {
      if (!productId) {
        return fallbackUrl || 'https://via.placeholder.com/150x150/0000CD/ffffff?text=No+Image';
      }

      try {
        console.log('Loading image for product:', productId);
        const docRef = doc(db, 'products', productId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const productData = docSnap.data();
          console.log('Product data loaded:', productData);
          
          // CORRECTED: Handle Firebase image structure (array of objects with url)
          let imageUrl = fallbackUrl;
          
          if (productData.images && productData.images.length > 0) {
            // Extract URL from first image object
            imageUrl = productData.images[0].url || productData.images[0];
          } else if (productData.detailImages && productData.detailImages.length > 0) {
            imageUrl = productData.detailImages[0];
          } else if (productData.image) {
            imageUrl = productData.image;
          } else if (productData.primaryImage) {
            imageUrl = productData.primaryImage;
          }
          
          console.log('Using image URL:', imageUrl);
          return imageUrl;
        } else {
          console.log('Product not found in Firebase, using fallback');
        }
      } catch (error) {
        console.warn('Error loading product image from Firebase:', error);
      }
      
      return fallbackUrl || 'https://via.placeholder.com/150x150/0000CD/ffffff?text=Product';
    }

    // Enhanced cart rendering with Firebase images
    async function renderCart() {
      const cart = getCart();
      const cartSection = document.getElementById("cartSection");
      const cartBody = document.getElementById("cartTableBody");
      const mobileCartItems = document.getElementById("mobileCartItems");
      const emptyMessage = document.getElementById("emptyCartMessage");
      const taxSpan = document.getElementById("tax");
      const totalSpan = document.getElementById("total");
      const subtotalSpan = document.getElementById("subtotal");

      cartBody.innerHTML = "";
      mobileCartItems.innerHTML = "";

      if (cart.length === 0) {
        cartSection.classList.add("hidden");
        emptyMessage.classList.remove("hidden");
        return;
      }

      cartSection.classList.remove("hidden");
      emptyMessage.classList.add("hidden");

      let subtotal = 0;

      // Show loading state first
      for (let index = 0; index < cart.length; index++) {
        const item = cart[index];
        const total = item.qty * item.price;
        subtotal += total;

        // Create placeholder row with loading image
        createCartRow(item, index, total, 'https://via.placeholder.com/60x60/f0f0f0/999999?text=Loading...', true);
      }

      // Then load actual images asynchronously
      for (let index = 0; index < cart.length; index++) {
        const item = cart[index];
        const total = item.qty * item.price;

        try {
          // Load the actual Firebase image
          const imageUrl = await loadProductImage(item.id, item.image);
          
          // Update the row with actual image
          createCartRow(item, index, total, imageUrl, false);
        } catch (error) {
          console.warn('Failed to load image for item:', item.id, error);
          // Keep placeholder if Firebase fails
          createCartRow(item, index, total, item.image || 'https://via.placeholder.com/60x60/0000CD/ffffff?text=Product', false);
        }
      }

      // Update totals
      const tax = 0;
      const grandTotal = subtotal + tax;

      subtotalSpan.textContent = `KES ${subtotal.toLocaleString()}`;
      taxSpan.textContent = `KES ${tax.toLocaleString()}`;
      totalSpan.textContent = `KES ${grandTotal.toLocaleString()}`;
    }

    function createCartRow(item, index, total, imageUrl, isLoading) {
      const cartBody = document.getElementById("cartTableBody");
      const mobileCartItems = document.getElementById("mobileCartItems");

      // Remove existing row if updating
      const existingRow = document.getElementById(`cart-row-${index}`);
      const existingMobileCard = document.getElementById(`mobile-card-${index}`);
      
      if (existingRow) existingRow.remove();
      if (existingMobileCard) existingMobileCard.remove();

      // Desktop table row
      const row = document.createElement("tr");
      row.id = `cart-row-${index}`;
      row.className = "cart-item text-sm";

      const imageClass = isLoading ? "product-image w-12 h-12 md:w-14 md:h-14 rounded-lg object-cover image-loading" : "product-image w-12 h-12 md:w-14 md:h-14 rounded-lg object-cover image-loaded";

      row.innerHTML = `
        <td class="px-3 md:px-4 py-3 font-medium" style="color: var(--brand-blue);">${index + 1}</td>
        <td class="px-3 md:px-6 py-3">
          <div class="flex items-center gap-3">
            <img src="${imageUrl}" 
                 alt="${item.name}" 
                 class="${imageClass}"
                 onerror="this.src='https://via.placeholder.com/60x60/0000CD/ffffff?text=Product'">
            <div class="min-w-0 flex-1">
              <p class="font-semibold text-sm md:text-base truncate" style="color: var(--brand-blue);">${item.name}</p>
              <p class="text-xs text-gray-500 mt-0.5">${item.brand || 'AMEXAN'}</p>
              <p class="text-xs text-gray-400 mt-0.5">SKU: ${item.id || 'N/A'}</p>
            </div>
          </div>
        </td>
        <td class="px-3 md:px-4 py-3">
          <div class="flex items-center">
            ${item.color && item.color !== 'Default' ? `
              <span class="inline-block w-4 h-4 rounded-full border border-gray-300 mr-1.5" style="background-color:${item.color}"></span>
              <span class="text-gray-700 text-xs truncate">${item.color}</span>
            ` : '<span class="text-gray-500 text-xs">Default</span>'}
          </div>
        </td>
        <td class="px-3 md:px-4 py-3 font-bold text-sm" style="color: var(--brand-blue);">KES ${item.price.toLocaleString()}</td>
        <td class="px-3 md:px-4 py-3">
          <div class="flex items-center justify-center gap-1">
            <button onclick="changeQty(${index}, -1)" class="qty-btn w-6 h-6 rounded flex items-center justify-center text-xs" style="background-color: var(--brand-blue-light); color: var(--brand-blue);">
              âˆ’
            </button>
            <span class="font-bold w-8 text-center text-sm">${item.qty}</span>
            <button onclick="changeQty(${index}, 1)" class="qty-btn w-6 h-6 rounded flex items-center justify-center text-xs" style="background-color: var(--brand-blue-light); color: var(--brand-blue);">
              +
            </button>
          </div>
        </td>
        <td class="px-3 md:px-4 py-3 font-bold text-green-600 text-sm">KES ${total.toLocaleString()}</td>
        <td class="px-3 md:px-4 py-3 text-right">
          <button onclick="removeItem(${index})" class="remove-btn bg-red-100 text-red-700 hover:text-red-900 px-2 py-1 rounded text-xs font-medium">
            Remove
          </button>
        </td>
      `;

      cartBody.appendChild(row);

      // Mobile card
      const mobileCard = document.createElement("div");
      mobileCard.id = `mobile-card-${index}`;
      mobileCard.className = "mobile-cart-card";
      
      const mobileImageClass = isLoading ? "mobile-product-image rounded-lg object-cover border-2 image-loading" : "mobile-product-image rounded-lg object-cover border-2 image-loaded";
      
      mobileCard.innerHTML = `
        <div class="flex items-start gap-3 mb-3">
          <img src="${imageUrl}" 
               alt="${item.name}" 
               class="${mobileImageClass}" 
               style="border-color: var(--brand-blue-light);"
               onerror="this.src='https://via.placeholder.com/60x60/0000CD/ffffff?text=Product'">
          <div class="flex-1 min-w-0">
            <h3 class="mobile-title font-bold mb-1 truncate" style="color: var(--brand-blue);">${item.name}</h3>
            <p class="text-xs text-gray-500 mb-1">${item.brand || 'AMEXAN'}</p>
            <p class="text-xs text-gray-400 mb-1">SKU: ${item.id || 'N/A'}</p>
            ${item.color && item.color !== 'Default' ? `
              <div class="flex items-center mb-2">
                <span class="inline-block w-3 h-3 rounded-full border border-gray-300 mr-1.5" style="background-color:${item.color}"></span>
                <span class="text-gray-700 text-xs">${item.color}</span>
              </div>
            ` : '<p class="text-xs text-gray-500 mb-2">Color: Default</p>'}
            <p class="font-bold text-sm" style="color: var(--brand-blue);">KES ${item.price.toLocaleString()}</p>
          </div>
        </div>
        
        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium text-gray-600">Qty:</span>
            <div class="flex items-center gap-1">
              <button onclick="changeQty(${index}, -1)" class="qty-btn w-6 h-6 rounded flex items-center justify-center text-xs" style="background-color: var(--brand-blue-light); color: var(--brand-blue);">
                âˆ’
              </button>
              <span class="font-bold w-6 text-center text-sm">${item.qty}</span>
              <button onclick="changeQty(${index}, 1)" class="qty-btn w-6 h-6 rounded flex items-center justify-center text-xs" style="background-color: var(--brand-blue-light); color: var(--brand-blue);">
                +
              </button>
            </div>
          </div>
          
          <div class="text-right">
            <p class="text-xs text-gray-500">Total</p>
            <p class="font-bold text-sm text-green-600">KES ${total.toLocaleString()}</p>
          </div>
        </div>
        
        <div class="mt-3">
          <button onclick="removeItem(${index})" class="remove-btn bg-red-100 text-red-700 hover:text-red-900 px-3 py-1.5 rounded font-medium text-xs w-full">
            Remove Item
          </button>
        </div>
      `;

      mobileCartItems.appendChild(mobileCard);
    }

    function changeQty(index, delta) {
      const cart = getCart();
      cart[index].qty += delta;
      
      if (cart[index].qty <= 0) {
        if (confirm("Remove this item from your cart?")) {
          cart.splice(index, 1);
        } else {
          cart[index].qty = 1;
        }
      }
      
      saveCart(cart);
      renderCart();
    }

    function removeItem(index) {
      if (confirm("Are you sure you want to remove this item?")) {
        const cart = getCart();
        cart.splice(index, 1);
        saveCart(cart);
        renderCart();
      }
    }

    // Make functions globally accessible
    window.changeQty = changeQty;
    window.removeItem = removeItem;

    // Initialize the cart when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Cart page loaded, initializing...');
      updateCartCount();
      renderCart();
    });

  </script>
</body>
</html>